{{ 'custom-carousel.css' | asset_url | stylesheet_tag }}
<style>
  /* Inline fallback styles to ensure status bars render and animate */
  .carousel-status-bars {
    position: absolute;
    bottom: 20px;
    left: 30px;
    right: 30px;
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
    height: 10px;
  }
  .status-bar {
    width: calc((100% - 20px) / 3);
    height: 10px;
    background-color: rgba(255, 255, 255, 0.25);
    border-radius: 5px;
    overflow: hidden;
    position: relative;
    display: inline-block;
  }
  .status-bar:not(:last-child) {
    margin-right: 10px;
  }
  .status-bar-fill {
    height: 100%;
    width: 0%;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 5px;
    transition: width 5s linear;
  }
  @media screen and (max-width: 749px) {
    .carousel-status-bars {
      display: none;
    }
  }
</style>

<div class="custom-carousel-wrapper page-width-none section custom-carousel-section" id="section-{{ section.id }}">
  <div class="custom-carousel" id="carousel-{{ section.id }}">
    <!-- Slide 1: Two columns desktop, single column mobile -->
    <div class="carousel-slide active" data-slide="1">
      {%- if section.settings.slide1_link != blank -%}
        <a href="{{ section.settings.slide1_link }}" class="slide-link" aria-label="Navigate to slide 1 link">
      {%- endif -%}
      <div class="slide-content two-columns">
        <!-- Desktop: Two columns -->
        <div class="column desktop-only">
          {%- if section.settings.slide1_image1 != blank -%}
            <img
              src="{{ section.settings.slide1_image1 | image_url: width: 800 }}"
              alt="{{ section.settings.slide1_image1.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.slide1_image1.width }}"
              height="{{ section.settings.slide1_image1.height }}"
            >
          {%- else -%}
            <div class="placeholder-image">
              <span>Image 1</span>
            </div>
          {%- endif -%}
        </div>
        <div class="column desktop-only">
          {%- if section.settings.slide1_image2 != blank -%}
            <img
              src="{{ section.settings.slide1_image2 | image_url: width: 800 }}"
              alt="{{ section.settings.slide1_image2.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.slide1_image2.width }}"
              height="{{ section.settings.slide1_image2.height }}"
            >
          {%- else -%}
            <div class="placeholder-image">
              <span>Image 2</span>
            </div>
          {%- endif -%}
        </div>
        <!-- Mobile: Single image -->
        <div class="column mobile-only">
          {%- if section.settings.slide1_mobile_image != blank -%}
            <img
              src="{{ section.settings.slide1_mobile_image | image_url: width: 800 }}"
              alt="{{ section.settings.slide1_mobile_image.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.slide1_mobile_image.width }}"
              height="{{ section.settings.slide1_mobile_image.height }}"
            >
          {%- else -%}
            <div class="placeholder-image">
              <span>Mobile Image 1</span>
            </div>
          {%- endif -%}
        </div>
      </div>
      <!-- Desktop text overlay -->
      <div class="slide-text-overlay desktop-only">
        {%- if section.settings.slide1_text != blank -%}
          <p class="slide-small-text">{{ section.settings.slide1_text }}</p>
        {%- else -%}
          <p class="slide-small-text">Sample small text for slide 1</p>
        {%- endif -%}
        {%- if section.settings.slide1_title != blank -%}
          <h2 class="slide-title">{{ section.settings.slide1_title }}</h2>
        {%- else -%}
          <h2 class="slide-title">Sample Title One</h2>
        {%- endif -%}
      </div>
      {%- if section.settings.slide1_link != blank -%}
        </a>
      {%- endif -%}
    </div>

    <!-- Slide 2: Two columns desktop, single column mobile -->
    <div class="carousel-slide" data-slide="2">
      {%- if section.settings.slide2_link != blank -%}
        <a href="{{ section.settings.slide2_link }}" class="slide-link" aria-label="Navigate to slide 2 link">
      {%- endif -%}
      <div class="slide-content two-columns">
        <!-- Desktop: Two columns -->
        <div class="column desktop-only">
          {%- if section.settings.slide2_image1 != blank -%}
            <img
              src="{{ section.settings.slide2_image1 | image_url: width: 800 }}"
              alt="{{ section.settings.slide2_image1.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.slide2_image1.width }}"
              height="{{ section.settings.slide2_image1.height }}"
            >
          {%- else -%}
            <div class="placeholder-image">
              <span>Image 3</span>
            </div>
          {%- endif -%}
        </div>
        <div class="column desktop-only">
          {%- if section.settings.slide2_image2 != blank -%}
            <img
              src="{{ section.settings.slide2_image2 | image_url: width: 800 }}"
              alt="{{ section.settings.slide2_image2.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.slide2_image2.width }}"
              height="{{ section.settings.slide2_image2.height }}"
            >
          {%- else -%}
            <div class="placeholder-image">
              <span>Image 4</span>
            </div>
          {%- endif -%}
        </div>
        <!-- Mobile: Single image -->
        <div class="column mobile-only">
          {%- if section.settings.slide2_mobile_image != blank -%}
            <img
              src="{{ section.settings.slide2_mobile_image | image_url: width: 800 }}"
              alt="{{ section.settings.slide2_mobile_image.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.slide2_mobile_image.width }}"
              height="{{ section.settings.slide2_mobile_image.height }}"
            >
          {%- else -%}
            <div class="placeholder-image">
              <span>Mobile Image 2</span>
            </div>
          {%- endif -%}
        </div>
      </div>
      <!-- Desktop text overlay -->
      <div class="slide-text-overlay desktop-only">
        {%- if section.settings.slide2_text != blank -%}
          <p class="slide-small-text">{{ section.settings.slide2_text }}</p>
        {%- else -%}
          <p class="slide-small-text">Sample small text for slide 2</p>
        {%- endif -%}
        {%- if section.settings.slide2_title != blank -%}
          <h2 class="slide-title">{{ section.settings.slide2_title }}</h2>
        {%- else -%}
          <h2 class="slide-title">Sample Title Two</h2>
        {%- endif -%}
      </div>
      {%- if section.settings.slide2_link != blank -%}
        </a>
      {%- endif -%}
    </div>

    <!-- Slide 3: One column desktop and mobile -->
    <div class="carousel-slide" data-slide="3">
      {%- if section.settings.slide3_link != blank -%}
        <a href="{{ section.settings.slide3_link }}" class="slide-link" aria-label="Navigate to slide 3 link">
      {%- endif -%}
      <div class="slide-content one-column">
        <!-- Desktop: Full width image -->
        <div class="column desktop-only">
          {%- if section.settings.slide3_image != blank -%}
            <img
              src="{{ section.settings.slide3_image | image_url: width: 1600 }}"
              alt="{{ section.settings.slide3_image.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.slide3_image.width }}"
              height="{{ section.settings.slide3_image.height }}"
            >
          {%- else -%}
            <div class="placeholder-image">
              <span>Full Width Image</span>
            </div>
          {%- endif -%}
        </div>
        <!-- Mobile: Single image -->
        <div class="column mobile-only">
          {%- if section.settings.slide3_mobile_image != blank -%}
            <img
              src="{{ section.settings.slide3_mobile_image | image_url: width: 800 }}"
              alt="{{ section.settings.slide3_mobile_image.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.slide3_mobile_image.width }}"
              height="{{ section.settings.slide3_mobile_image.height }}"
            >
          {%- else -%}
            <div class="placeholder-image">
              <span>Mobile Image 3</span>
            </div>
          {%- endif -%}
        </div>
      </div>
      <!-- Desktop text overlay -->
      <div class="slide-text-overlay desktop-only">
        {%- if section.settings.slide3_text != blank -%}
          <p class="slide-small-text">{{ section.settings.slide3_text }}</p>
        {%- else -%}
          <p class="slide-small-text">Sample small text for slide 3</p>
        {%- endif -%}
        {%- if section.settings.slide3_title != blank -%}
          <h2 class="slide-title">{{ section.settings.slide3_title }}</h2>
        {%- else -%}
          <h2 class="slide-title">Sample Title Three</h2>
        {%- endif -%}
      </div>
      {%- if section.settings.slide3_link != blank -%}
        </a>
      {%- endif -%}
    </div>
  </div>

  <!-- Status bars -->
  <div class="carousel-status-bars desktop-only">
    <div class="status-bar" data-slide="1">
      <div class="status-bar-fill"></div>
    </div>
    <div class="status-bar" data-slide="2">
      <div class="status-bar-fill"></div>
    </div>
    <div class="status-bar" data-slide="3">
      <div class="status-bar-fill"></div>
    </div>
  </div>
</div>

<script>
  (function () {
    console.log('🎠 Carousel initialization starting...');

    const sectionWrapper = document.getElementById('section-{{ section.id }}');
    if (!sectionWrapper) {
      console.error('❌ Section wrapper not found:', 'section-{{ section.id }}');
      return;
    }
    console.log('✅ Found section wrapper:', sectionWrapper);

    if (sectionWrapper.dataset.carouselInitialized === 'true') {
      console.log('ℹ️ Carousel already initialized. Skipping re-init.');
      return;
    }

    const carousel = sectionWrapper.querySelector('#carousel-{{ section.id }}');
    if (!carousel) {
      console.error('❌ Carousel element not found:', 'carousel-{{ section.id }}');
      return;
    }
    console.log('✅ Found carousel element:', carousel);

    const slides = carousel.querySelectorAll('.carousel-slide');
    console.log('📊 Found slides:', slides.length);
    // Removed indicators and navigation buttons
    let currentSlide = 1;
    let autoSlideInterval;
    // Progress animation state
    let progressRafId = null;
    let progressStartTime = 0;
    let progressStartPct = 0; // 0..1
    // Progress animation using transition/RAF for reliability
    let slideTimeoutId = null;
    let isAnimating = false;

    function showSlide(slideNumber) {
      // Remove active class from all slides
      slides.forEach((slide) => slide.classList.remove('active'));

      // Add active class to current slide
      const targetSlide = carousel.querySelector(`[data-slide="${slideNumber}"]`);

      if (targetSlide) {
        targetSlide.classList.add('active');
      }

      // Cancel any running progress animation and update status bars
      cancelProgressRaf();
      // Update status bars
      updateStatusBars(slideNumber);

      currentSlide = slideNumber;
    }

    function cancelProgressRaf() {
      if (progressRafId !== null) {
        cancelAnimationFrame(progressRafId);
        progressRafId = null;
      }
    }

    function resetAllBars(activeSlide) {
      console.log('🔄 Resetting status bars for slide:', activeSlide);

      const statusBars = sectionWrapper.querySelectorAll('.status-bar');
      console.log('📊 Found status bars:', statusBars.length);

      statusBars.forEach((bar, index) => {
        const slideNum = index + 1;
        const fill = bar.querySelector('.status-bar-fill');
        if (!fill) {
          console.error('❌ Fill element not found for bar:', slideNum);
          return;
        }

        // Stop any running animations/transitions and set base width
        fill.style.transition = 'none';
        fill.style.animation = 'none';

        if (slideNum === activeSlide) {
          // Current slide: start at 0% (will be animated)
          fill.style.width = '0%';
          fill.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
        } else if (slideNum < activeSlide || (activeSlide === 1 && slideNum > 1)) {
          // Previous slides OR when cycling back to slide 1, reset slides 2&3
          if (activeSlide === 1) {
            // When back to slide 1, all other bars should be empty
            fill.style.width = '0%';
            fill.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
          } else {
            // Normal case: previous slides are filled
            fill.style.width = '100%';
            fill.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
          }
        } else {
          // Future slides: empty
          fill.style.width = '0%';
          fill.style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
        }
      });
    }

    function animateActiveBar(activeSlide) {
      const activeFill = sectionWrapper.querySelector(`.status-bar[data-slide="${activeSlide}"] .status-bar-fill`);
      if (!activeFill) {
        console.warn('⚠️ Active fill not found for slide:', activeSlide);
        return;
      }

      // Clear any existing timeout to prevent multiple timers
      if (slideTimeoutId) {
        clearTimeout(slideTimeoutId);
        slideTimeoutId = null;
      }

      // Simple approach: reset to 0%, then transition to 100%
      activeFill.style.transition = 'none';
      activeFill.style.width = '0%';
      activeFill.style.backgroundColor = 'rgba(255, 255, 255, 0.8)'; // Make sure it's visible

      // Force browser reflow
      activeFill.offsetHeight;

      // Start transition and advance slide after 5s
      activeFill.style.transition = 'width 5s linear';
      activeFill.style.width = '100%';

      isAnimating = true;
      slideTimeoutId = setTimeout(() => {
        slideTimeoutId = null;
        isAnimating = false;
        nextSlide();
      }, 5000);

      console.log('✅ Started animation for slide:', activeSlide);
    }

    function updateStatusBars(activeSlide) {
      resetAllBars(activeSlide);
      animateActiveBar(activeSlide);
    }

    function pauseBarAnimation() {
      const activeBar = sectionWrapper.querySelector(`.status-bar[data-slide="${currentSlide}"] .status-bar-fill`);
      if (!activeBar) return;
      // Pause CSS animation by computing current progress and freezing width
      const computed = getComputedStyle(activeBar);
      const matrix = computed.transform;
      let pct = 0;
      try {
        const rect = activeBar.getBoundingClientRect();
        const parentRect = activeBar.parentElement.getBoundingClientRect();
        pct = parentRect.width ? (rect.width / parentRect.width) * 100 : 0;
      } catch (e) {}
      activeBar.classList.remove('is-animating');
      activeBar.style.transition = 'none';
      activeBar.style.animation = 'none';
      activeBar.style.width = `${pct}%`;
      console.log('⏸️ Paused at % (width):', pct);
    }

    function resumeBarAnimation() {
      const activeBar = sectionWrapper.querySelector(`.status-bar[data-slide="${currentSlide}"] .status-bar-fill`);
      if (!activeBar) return;
      // Resume from current width using remaining duration
      const rect = activeBar.getBoundingClientRect();
      const parentRect = activeBar.parentElement.getBoundingClientRect();
      const progressPct = parentRect.width ? (rect.width / parentRect.width) * 100 : 0;
      const remaining = Math.max(0, 5000 * (1 - progressPct / 100));
      activeBar.style.transition = `width ${remaining}ms linear`;
      requestAnimationFrame(() => {
        activeBar.style.width = '100%';
      });
      // Also re-attach animationend advance in case width transition completes
      const onTransitionEnd = () => {
        activeBar.removeEventListener('transitionend', onTransitionEnd);
        nextSlide();
      };
      activeBar.addEventListener('transitionend', onTransitionEnd, { once: true });
      console.log('▶️ Resumed (width) remaining ms:', remaining);
    }

    function nextSlide() {
      if (isAnimating) {
        console.log('⚠️ Animation already in progress, skipping advance');
        return;
      }

      const next = currentSlide >= 3 ? 1 : currentSlide + 1;
      console.log(`🔄 Advancing from slide ${currentSlide} to slide ${next}`);
      showSlide(next);
    }

    function prevSlide() {
      const prev = currentSlide <= 1 ? 3 : currentSlide - 1;
      showSlide(prev);
    }

    // Removed timer-based auto-slide; slide advances on animationend/transitionend

    // Hover pause removed per request

    // Immediately start filling the first bar
    function initializeFirstBar() {
      console.log('🎬 Initializing first status bar (transition mode)...');
      const firstBar = sectionWrapper.querySelector('.status-bar[data-slide="1"] .status-bar-fill');
      if (!firstBar) {
        console.error('❌ First status bar fill element not found');
        return;
      }
      console.log('✅ Found first status bar:', firstBar);
      animateActiveBar(1);
    }

    // Initialize everything
    console.log('🚀 Starting carousel initialization...');
    showSlide(1);
    initializeFirstBar();

    // Mark as initialized to avoid duplicate setups
    sectionWrapper.dataset.carouselInitialized = 'true';

    // Shopify Theme Editor lifecycle hooks
    document.addEventListener('shopify:section:unload', (event) => {
      if (!event || !event.detail) return;
      if (event.detail.sectionId === '{{ section.id }}') {
        // Cleanup timers and animations
        stopAutoSlide();
        cancelProgressRaf();
      }
    });
    document.addEventListener('shopify:section:load', (event) => {
      if (!event || !event.detail) return;
      if (event.detail.sectionId === '{{ section.id }}') {
        const wrapper = document.getElementById('section-{{ section.id }}');
        if (wrapper && wrapper.dataset.carouselInitialized !== 'true') {
          console.log('🔁 Re-initializing carousel on shopify:section:load');
          showSlide(1);
          initializeFirstBar();
          wrapper.dataset.carouselInitialized = 'true';
        }
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Custom Carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "🖼️ Slide 1 - Two Column Layout"
    },
    {
      "type": "paragraph",
      "content": "Upload two images that will be displayed side by side in the first slide."
    },
    {
      "type": "image_picker",
      "id": "slide1_image1",
      "label": "Left Image",
      "info": "Recommended size: 800x600px or larger"
    },
    {
      "type": "image_picker",
      "id": "slide1_image2",
      "label": "Right Image",
      "info": "Recommended size: 800x600px or larger"
    },
    {
      "type": "image_picker",
      "id": "slide1_mobile_image",
      "label": "Mobile Image",
      "info": "Single image for mobile view - Recommended size: 800x1000px or larger"
    },
    {
      "type": "text",
      "id": "slide1_text",
      "label": "Small Text",
      "info": "Optional: Small text displayed at bottom (24px)"
    },
    {
      "type": "text",
      "id": "slide1_title",
      "label": "Title",
      "info": "Optional: Title displayed below small text (48px)"
    },
    {
      "type": "url",
      "id": "slide1_link",
      "label": "Slide 1 Link",
      "info": "Optional: Make this slide clickable by adding a link"
    },
    {
      "type": "header",
      "content": "🖼️ Slide 2 - Two Column Layout"
    },
    {
      "type": "paragraph",
      "content": "Upload two images that will be displayed side by side in the second slide."
    },
    {
      "type": "image_picker",
      "id": "slide2_image1",
      "label": "Left Image",
      "info": "Recommended size: 800x600px or larger"
    },
    {
      "type": "image_picker",
      "id": "slide2_image2",
      "label": "Right Image",
      "info": "Recommended size: 800x600px or larger"
    },
    {
      "type": "image_picker",
      "id": "slide2_mobile_image",
      "label": "Mobile Image",
      "info": "Single image for mobile view - Recommended size: 800x1000px or larger"
    },
    {
      "type": "text",
      "id": "slide2_text",
      "label": "Small Text",
      "info": "Optional: Small text displayed at bottom (24px)"
    },
    {
      "type": "text",
      "id": "slide2_title",
      "label": "Title",
      "info": "Optional: Title displayed below small text (48px)"
    },
    {
      "type": "url",
      "id": "slide2_link",
      "label": "Slide 2 Link",
      "info": "Optional: Make this slide clickable by adding a link"
    },
    {
      "type": "header",
      "content": "🖼️ Slide 3 - Full Width Layout"
    },
    {
      "type": "paragraph",
      "content": "Upload one image that will be displayed at full width in the third slide."
    },
    {
      "type": "image_picker",
      "id": "slide3_image",
      "label": "Full Width Image",
      "info": "Recommended size: 1920x1080px or larger for best quality"
    },
    {
      "type": "image_picker",
      "id": "slide3_mobile_image",
      "label": "Mobile Image",
      "info": "Single image for mobile view - Recommended size: 800x1000px or larger"
    },
    {
      "type": "text",
      "id": "slide3_text",
      "label": "Small Text",
      "info": "Optional: Small text displayed at bottom (24px)"
    },
    {
      "type": "text",
      "id": "slide3_title",
      "label": "Title",
      "info": "Optional: Title displayed below small text (48px)"
    },
    {
      "type": "url",
      "id": "slide3_link",
      "label": "Slide 3 Link",
      "info": "Optional: Make this slide clickable by adding a link"
    },
    {
      "type": "header",
      "content": "⚙️ Carousel Settings"
    },
    {
      "type": "paragraph",
      "content": "The carousel automatically changes slides every 5 seconds and pauses when you hover over it."
    }
  ],
  "presets": [
    {
      "name": "Custom Carousel",
      "category": "Image"
    }
  ]
}
{% endschema %}
