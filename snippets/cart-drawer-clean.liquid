{% comment %}
  Renders cart drawer

  Usage:
  {% render 'cart-drawer' %}
{% endcomment %}

{{ 'quantity-popover.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'custom-cart-drawer.css' | asset_url | stylesheet_tag }}

<script src="{{ 'cart.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'quantity-popover.js' | asset_url }}" defer="defer"></script>

<style>
  .drawer {
    visibility: hidden;
  }
</style>

<cart-drawer class="drawer{% if cart == empty %} is-empty{% endif %}">
  <div id="CartDrawer" class="cart-drawer">
    <div id="CartDrawer-Overlay" class="cart-drawer__overlay"></div>
    <div
      class="drawer__inner gradient color-{{ settings.cart_color_scheme }}"
      role="dialog"
      aria-modal="true"
      aria-label="{{ 'sections.cart.title' | t }}"
      tabindex="-1"
    >
      <!-- Top Checkout CTA inside cart drawer -->
      <div class="cart-top-cta">
        <a
          href="{{ routes.cart_url }}"
          class="button button--primary cart__checkout-button{% if cart == empty %} is-disabled{% endif %}"
          name="checkout"
          {% if cart == empty %}
            aria-disabled="true" tabindex="-1"
          {% endif %}
        >
          {{- 'sections.cart.checkout' | t -}}
        </a>
        {% if cart == empty %}
          <div class="cart-top-empty-note">YOUR CART IS EMPTY</div>
        {% endif %}
      </div>
      {%- if cart == empty -%}
        <!-- Empty cart state handled by top message -->
      {%- endif -%}
      <div class="drawer__header">
        <h2 class="drawer__heading">{{ 'sections.cart.title' | t }}</h2>
      </div>
      <cart-drawer-items
        {% if cart == empty %}
          class=" is-empty"
        {% endif %}
      >
        <form
          action="{{ routes.cart_url }}"
          id="CartDrawer-Form"
          class="cart__contents cart-drawer__form"
          method="post"
        >
          <div id="CartDrawer-CartItems" class="drawer__contents js-contents">
            {%- if cart != empty -%}
              <div class="drawer__cart-items-wrapper">
                <div class="cart-header">
                  <div class="cart-header-left">PRODUCT</div>
                  <div class="cart-header-center">PRODUCT NAME</div>
                  <div class="cart-header-right">000 USD</div>
                </div>

                {%- for item in cart.items -%}
                  <div class="cart-item-row" id="CartDrawer-Item-{{ item.index | plus: 1 }}">
                    <div class="cart-item-left">
                      <div class="cart-item-product">PRODUCT</div>
                    </div>

                    <div class="cart-item-center">
                      <div class="cart-item-name">{{ item.product.title | escape }}</div>

                      <div class="cart-item-details">
                        {%- if item.product.has_only_default_variant == false -%}
                          {%- for option in item.options_with_values -%}
                            <div class="cart-item-option">
                              <span class="option-name">{{ option.name | upcase }}</span>
                              <span class="option-value">{{ option.value | upcase }}</span>
                            </div>
                          {%- endfor -%}
                        {%- endif -%}

                        <div class="cart-item-quantity">
                          <span class="quantity-label">QUANTITY</span>
                          <span class="quantity-value">{{ item.quantity | sprintf: '%02d' }}</span>
                          <div class="quantity-controls">
                            <button
                              class="quantity-add"
                              type="button"
                              onclick="updateQuantity({{ item.index | plus: 1 }}, {{ item.quantity | plus: 1 }})"
                            >
                              ADD
                            </button>
                            <button
                              class="quantity-remove"
                              type="button"
                              onclick="updateQuantity({{ item.index | plus: 1 }}, {{ item.quantity | minus: 1 }})"
                            >
                              REMOVE
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="cart-item-right">
                      <div class="cart-item-price">{{ item.final_price | money | remove: '.00' }} USD</div>
                    </div>

                    <!-- Hidden quantity input for cart updates -->
                    <input
                      type="hidden"
                      name="updates[]"
                      value="{{ item.quantity }}"
                      data-index="{{ item.index | plus: 1 }}"
                    >
                  </div>
                {%- endfor -%}

                <div class="cart-total-section">
                  <div class="cart-total-line">
                    <span class="total-label">TOTAL</span>
                    <span class="total-amount">{{ cart.total_price | money | remove: '.00' }} USD</span>
                  </div>
                </div>
              </div>
            {%- endif -%}
            <p id="CartDrawer-LiveRegionText" class="visually-hidden" role="status"></p>
            <p id="CartDrawer-LineItemStatus" class="visually-hidden" aria-hidden="true" role="status">
              {{ 'accessibility.loading' | t }}
            </p>
          </div>
          <div id="CartDrawer-CartErrors" role="alert"></div>
        </form>
      </cart-drawer-items>
    </div>
  </div>
</cart-drawer>

<script>
  function updateQuantity(lineIndex, newQuantity) {
    if (newQuantity < 0) newQuantity = 0;

    const form = document.getElementById('CartDrawer-Form');
    const input = form.querySelector(`input[data-index="${lineIndex}"]`);

    if (input) {
      input.value = newQuantity;

      fetch('/cart/change.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          line: lineIndex,
          quantity: newQuantity,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          // Reload cart drawer content
          location.reload();
        })
        .catch((error) => {
          console.error('Error updating cart:', error);
        });
    }
  }
</script>
